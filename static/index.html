<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YuhHearDem - Barbados Parliamentary Knowledge Graph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                YuhHearDem
            </h1>
            <p class="text-gray-600">
                Barbados Parliamentary Knowledge Graph - Ask questions about parliamentary sessions, legislation, and more.
            </p>
        </header>

        <!-- Connection Status -->
        <div id="connection-status" class="mb-4 p-3 rounded bg-yellow-100 text-yellow-800">
            <span class="font-semibold">Connecting to server...</span>
        </div>

        <!-- Chat Interface -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Messages Container -->
            <div id="messages" class="h-96 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <div class="text-center text-gray-500 py-8">
                    <p>Ask a question about Barbados Parliament to get started.</p>
                </div>
            </div>

            <!-- Input Form -->
            <div class="p-4 border-t border-gray-200">
                <form id="chat-form" class="flex gap-3">
                    <input
                        type="text"
                        id="query-input"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Ask about legislation, speeches, or parliamentary proceedings..."
                        required
                    />
                    <button
                        type="submit"
                        id="submit-btn"
                        class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Send
                    </button>
                </form>
            </div>
        </div>

        <!-- Session Info -->
        <div id="session-info" class="mt-4 p-3 bg-gray-100 rounded text-sm text-gray-600">
            <span>Session: <span id="session-id">Not connected</span></span>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let sessionId = null;
        let userId = null;

        // Generate user ID on first visit
        function generateUserId() {
            let userId = localStorage.getItem('yuhheardem_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('yuhheardem_user_id', userId);
            }
            return userId;
        }

        // Check connection status
        async function checkConnection() {
            try {
                const response = await fetch('/health');
                const statusEl = document.getElementById('connection-status');
                if (response.ok) {
                    statusEl.className = 'mb-4 p-3 rounded bg-green-100 text-green-800';
                    statusEl.innerHTML = '<span class="font-semibold">Connected to server</span>';
                    return true;
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                const statusEl = document.getElementById('connection-status');
                statusEl.className = 'mb-4 p-3 rounded bg-red-100 text-red-800';
                statusEl.innerHTML = `<span class="font-semibold">Connection failed: ${error.message}</span>`;
                return false;
            }
        }

        // Send query to API
        async function sendQuery(query, useStream = true) {
            const form = document.getElementById('chat-form');
            const input = document.getElementById('query-input');
            const submitBtn = document.getElementById('submit-btn');

            // Disable form during request
            input.disabled = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                if (useStream) {
                    // Use SSE streaming
                    await sendQueryStream(query);
                } else {
                    // Use regular API
                    await sendQueryRegular(query);
                }
            } catch (error) {
                addMessage('assistant', 'Error: ' + error.message, null);
            } finally {
                // Re-enable form
                input.disabled = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send';
                input.value = '';
                input.focus();
            }
        }

        // Send query using regular API
        async function sendQueryRegular(query) {
            const response = await fetch(`${API_URL}/query`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    user_id: userId,
                    session_id: sessionId
                })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();

            // Update session ID
            sessionId = data.session_id;
            document.getElementById('session-id').textContent = sessionId;

            // Display structured response
            displayStructuredResponse(data.structured_response);
        }

        // Send query using SSE streaming
        async function sendQueryStream(query) {
            const response = await fetch(`${API_URL}/query/stream`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    user_id: userId,
                    session_id: sessionId
                })
            });

            if (!response.ok) {
                throw new Error(`Stream error: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('event: ')) {
                        const eventType = line.substring(7).trim();

                        if (eventType === 'thinking') {
                            updateLastMessage('assistant', 'Thinking...');
                        } else if (eventType === 'response') {
                            // Parse data line
                            const nextLine = lines[lines.indexOf(line) + 1];
                            if (nextLine && nextLine.startsWith('data: ')) {
                                const jsonData = JSON.parse(nextLine.substring(6));
                                sessionId = jsonData.session_id;
                                document.getElementById('session-id').textContent = sessionId;
                                displayStructuredResponse(jsonData.structured_response);
                            }
                        } else if (eventType === 'error') {
                            const nextLine = lines[lines.indexOf(line) + 1];
                            if (nextLine && nextLine.startsWith('data: ')) {
                                const jsonData = JSON.parse(nextLine.substring(6));
                                updateLastMessage('assistant', 'Error: ' + jsonData.message);
                            }
                        }
                    }
                }
            }
        }

        // Add message to chat
        function addMessage(role, content, structuredResponse) {
            const messagesDiv = document.getElementById('messages');

            // Remove placeholder if exists
            const placeholder = messagesDiv.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user'
                ? 'flex justify-end'
                : 'flex justify-start';

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = role === 'user'
                ? 'bg-blue-600 text-white px-4 py-2 rounded-lg max-w-2xl'
                : 'bg-white border border-gray-200 px-4 py-2 rounded-lg max-w-2xl shadow-sm';

            if (structuredResponse) {
                const intro = document.createElement('p');
                intro.className = 'font-semibold mb-2';
                intro.textContent = structuredResponse.intro_message;
                bubbleDiv.appendChild(intro);

                if (structuredResponse.response_cards && structuredResponse.response_cards.length > 0) {
                    const cardsDiv = document.createElement('div');
                    cardsDiv.className = 'space-y-3 mt-3';

                    structuredResponse.response_cards.forEach(card => {
                        const card = document.createElement('div');
                        card.className = 'bg-gray-50 p-3 rounded border border-gray-200';

                        const summary = document.createElement('h4');
                        summary.className = 'font-semibold text-gray-900 mb-1';
                        summary.textContent = card.summary;

                        const details = document.createElement('div');
                        details.className = 'prose prose-sm text-gray-700';
                        details.innerHTML = marked.parse(card.details);

                        card.appendChild(summary);
                        card.appendChild(details);
                        cardsDiv.appendChild(card);
                    });

                    bubbleDiv.appendChild(cardsDiv);
                }

                if (structuredResponse.follow_up_suggestions && structuredResponse.follow_up_suggestions.length > 0) {
                    const suggestionsDiv = document.createElement('div');
                    suggestionsDiv.className = 'mt-3 pt-3 border-t border-gray-200';

                    const suggestionsTitle = document.createElement('p');
                    suggestionsTitle.className = 'text-sm text-gray-600 mb-2';
                    suggestionsTitle.textContent = 'Follow-up questions:';

                    suggestionsDiv.appendChild(suggestionsTitle);

                    const suggestionsList = document.createElement('div');
                    suggestionsList.className = 'space-y-1';

                    structuredResponse.follow_up_suggestions.forEach(suggestion => {
                        const suggestionBtn = document.createElement('button');
                        suggestionBtn.className = 'text-left w-full px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded text-left';
                        suggestionBtn.textContent = 'â€¢ ' + suggestion;
                        suggestionBtn.onclick = () => {
                            document.getElementById('query-input').value = suggestion;
                            sendQuery(suggestion);
                        };
                        suggestionsList.appendChild(suggestionBtn);
                    });

                    suggestionsDiv.appendChild(suggestionsList);
                    bubbleDiv.appendChild(suggestionsDiv);
                }
            } else {
                const textDiv = document.createElement('div');
                textDiv.textContent = content;
                bubbleDiv.appendChild(textDiv);
            }

            messageDiv.appendChild(bubbleDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Update last assistant message
        function updateLastMessage(role, content) {
            const messagesDiv = document.getElementById('messages');
            const messages = messagesDiv.querySelectorAll('.flex');

            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                const bubbleDiv = lastMessage.querySelector('.bg-white');

                if (bubbleDiv) {
                    bubbleDiv.innerHTML = `<p>${content}</p>`;
                }
            }
        }

        // Display structured response
        function displayStructuredResponse(response) {
            addMessage('assistant', null, response);
        }

        // Initialize
        async function init() {
            userId = generateUserId();
            const connected = await checkConnection();

            if (connected) {
                // Restore session if exists
                sessionId = localStorage.getItem('yuhheardem_session_id');
                if (sessionId) {
                    document.getElementById('session-id').textContent = sessionId;
                }

                // Set up form handler
                document.getElementById('chat-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const query = document.getElementById('query-input').value.trim();
                    if (query) {
                        addMessage('user', query, null);
                        await sendQuery(query, true);
                    }
                });
            }
        }

        // Start application
        init();
    </script>
</body>
</html>
